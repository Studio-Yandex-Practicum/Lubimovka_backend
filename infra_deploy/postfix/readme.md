## Настройки DNS

Эти настройки нужны, чтобы другие почтовые сервера находили ваш сервер.
Нужно добавить по крайней мере две записи к таблице вашего домена.

Запись типа A, указывающая на IP вашего почтового сервера Postfix:
|Name|Type|IP Address|TTL|
|---|---|---|---|
|mail|A|<IP вашего сервера>|3600|

Запись типа MX, указывающая куда нужно обращаться для доставки почты для вашего домена, то есть на машину из первой записи:
|Name|Type|Priority|Mail Relay|TTL|
|---|---|---|---|---|
|@|MX|10|mail|3600|

Вместо графы, в таблице выше обозначенной как Mail Relay, в некоторых системах может ожидаться не поддомен, а полное доменное имя. Попробуйте выгрузить зону в текстовый файл и посмотреть как запись выглядит там.
Важно проверить, что MX запись в конечном счете указывает на правильный адрес. Сделать это можно командой

```bash
nslookup -type=mx <ваш_домен>
```
В полученном ответе должен быть адрес `mail.<ваш_домен>`.

Кроме этого можно добавить запись SPF. Эта запись определяет, какому серверу вы доверяете отправку почты от имени вашего домена.
|Name|Type|Text|TTL|
|---|---|---|---|
|@|TXT|v=spf1 mx -all|3600|

Сервер получателя может запросить эту запись на сервере имен отправителя. Далее, он должен проверить, что, как указывает часть `mx`, сообщение получено от сервера, который обозначен в записи MX домена, в свою очередь ссылающейся на запись для поддомена `mail`, указывающую на IP-адрес вашего сервера. Сообщения от всех серверов с другими IP-адресами необходимо отвергать, на что указывает часть `-all`.


## PTR-запись

Запись PTR обычно настраивается хостинг-провайдером. Эта запись должна связывать IP-адрес и доменное имя почтового сервера. Почтовый сервер получателя может быть настроен отвергать соединения от серверов с неправильно настроенной записью PTR.

Наличие и правильность записи PTR можно проверить командой
```bash
dig -x <ваш IP>
```

В ответе должна содержаться секция следующего вида
```
;; ANSWER SECTION:
<ваш IP в обратном порядке>.in-addr.arpa. 600 IN      PTR     mail.<ваш_домен>.
```

## Настройка взаимодейстия с Django

Postfix обращается непосредственно к базе данных Django для получения таблицы переадресации. В базе данных должен существовать пользователь `postfix` с правом выполнения запросов на чтение к таблице. Настройки доступа задаются в конфигурационном файле [pgsql-virtual.cf](pgsql-virtual.cf). Пароль и имя базы данных в конфигурационном файле автоматически заменяются скриптом, выполняемым при запуске контейнера, с использованием значений из переменных окружения.

Для того, чтобы иметь возможность подключаться к серверу базы данных, контейнер Postfix должен находиться в одной с ним сети Docker.


## Секреты

Секреты используются для инициализации переменных окружения на сервере.
В секреты Github нужно добавить следующие значения:

- POSTFIX_DB_PASSWORD - пароль для доступа к базе данных Django
- POSTFIX_HOSTNAME - доменное имя почтового сервера, например `mail.<ваш_домен>`
- POSTFIX_MAIL_DOMAIN - доменное имя адресов почты, например `<ваш_домен>`


## Запуск сервера

Сервер запускается одной из команд

```bash
sudo docker compose -f postfix-test.yaml --env-file ../.env-test up
```
```bash
sudo docker compose -f postfix-stage.yaml --env-file ../.env-stage up
```
```bash
sudo docker-compose -f postfix-prod.yaml --env-file ../.env-prod up
```

Файл с переменными `.env-...` указывается в командной строке, чтобы значения переменных из него были доступны внутри `compose`-файла.
